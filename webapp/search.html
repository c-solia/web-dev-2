<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiggyBank</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="title">
        <h1>PiggyBank</h1>
    </div>

    <div id="menu">
        <a href="/" class="nav">HOME </a>
        <a href="search" class="nav">SEARCH </a>
        <a href="fundraiser" class="nav">FUNDRAISERS </a>
    </div>

    <div id="search">
        <h3>Please enter at least one search criteria </h3>
        <form id="searchform">
            <ul>
                <li>
                    <label for="organiser">Organiser  </label>
                    <input type="text" id="organiser"/>
                </li>
                <li>
                    <label for="category">Category </label>
                    <select id="category" id="category"></select>
                </li>
                <li>
                    <label for="city">City </label>
                    <input type="text" id="city"/>
                </li>
                <li>
                    <input type="button" id="submit" value="Search" onclick="search()"/>
                    <input type="button" id="clear" value="Clear" onclick="clearTextBoxes()"/>
                </li>
            </ul>
        </form>
    </div>

    <p id="errorMessage"></p>                            

    <div id="data">
        
    </div>

    <div id="contact">
        <h3>Contact Us</h3>
        <p>Head Office: 28 Fake St, Brisbane 4000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Phone: (07) 5512 3456</p>
    </div>

    <script>
        function clearTextBoxes() {
            document.getElementById("searchform").reset();
            document.getElementById("errorMessage").innerHTML = "";
        }
        function search() {
            //creates the querystring to be used for the API
            var cat = document.getElementById("category").value;
            var city = document.getElementById("city").value;
            var org = document.getElementById("organiser").value;

            var url = "category="+cat+"&city="+city+"&organiser="+org;

            document.getElementById("errorMessage").innerHTML = "";

            if(cat === '' && city === '' && org === '') {
                document.getElementById("errorMessage").innerHTML = "Please enter at least 1 criteria";
            }
            else {
                console.log("http://localhost:3060/search?"+url);

                //call GET API to retrive fundraiser info based on user input
                fetch("http://localhost:3060/search?"+url)
                .then(response => response.json())
                .then(fund => {
                    const fundDiv = document.getElementById('data');
                    fundDiv.innerHTML = "";

                    if(fund.length > 0){
                        fund.forEach(   f => {
                            const newCard = document.createElement("div");
                            newCard.className = 'card';

                            //All images were generated using Canvas' magic maker tool

                            newCard.innerHTML = `
                            <h3>Help Support </h3>
                            <h2> ${f.ORGANIZER}</h2>
                            <div class="fundraiser-info">
                                <img src="${f.IMG_URL}"> 
                                <p> <strong>${f.CAPTION}</strong></p>
                                <p><strong>Funding Goal:</strong> $${f.TARGET_FUNDING}</p>
                                <p><strong>Money Raised:</strong> $${f.CURRENT_FUNDING}</p>
                                <p><strong>City:</strong> ${f.CITY}</p>
                                <p><strong>Active:</strong> ${f.ACTIVE ? 'Yes' : 'No'} &nbsp;&nbsp;&nbsp; <strong>Fundraiser #</strong>${f.FUNDRAISER_ID}</p>
                                <p><strong>Category:</strong> ${f.CATEGORY_NAME}</p>
                                <button onclick="location.href='http://localhost:3030/fundraiser/${f.FUNDRAISER_ID}'" type="button">Find Out More</button>
                            </div>
                        `;        
                        fundDiv.appendChild(newCard);
                        });
                    } 
                    else {
                        document.getElementById("errorMessage").innerHTML = "No matching fundraisers found";
                    }
                })
                .catch(error => {
                    console.error("Error occured while fetching data", error);
                    document.getElementById("errorMessage").innerHTML = "Error occured while fetching data";
                });
            }
        }

        //call GET api to retrieve list of categories from database
        fetch("http://localhost:3060/category")
        .then(response => response.json())
        .then(categories => {
            const options = document.getElementById('category');
            options.innerHTML = "";

            const opt = document.createElement("option");
            opt.text = "Choose";
            opt.value = "";

            options.appendChild(opt);

            if(categories.length > 0){
                categories.forEach(   c => {
                    const newOpt = document.createElement("option");

                    newOpt.text = c.NAME;
                    newOpt.value = c.NAME;
                    
                    options.appendChild(newOpt);
                })
            }
        })
        .catch(error => {
            console.error("Error occured while fetching categories", error);
            document.getElementById('categories').textContent="Failed to load categories";
        });
    </script>
</body>
</html>

